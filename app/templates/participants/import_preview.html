{% extends "base.html" %}

{% block content %}
<div class="bg-white shadow rounded-lg max-w-6xl mx-auto">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900">Import-Vorschau</h2>
    </div>

    <div class="px-6 py-6">
        <!-- Zusammenfassung -->
        <div class="mb-6 grid grid-cols-3 gap-4">
            <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                <div class="text-sm font-medium text-blue-800">Teilnehmer gesamt</div>
                <div class="mt-1 text-2xl font-semibold text-blue-900">{{ import_data.participants|length }}</div>
            </div>
            <div class="bg-green-50 border border-green-200 rounded-md p-4">
                <div class="text-sm font-medium text-green-800">Neue Familien</div>
                <div class="mt-1 text-2xl font-semibold text-green-900">{{ import_data.families|length }}</div>
            </div>
            <div class="bg-purple-50 border border-purple-200 rounded-md p-4">
                <div class="text-sm font-medium text-purple-800">Mit Fehlern</div>
                <div class="mt-1 text-2xl font-semibold text-purple-900">{{ import_data.errors|length }}</div>
            </div>
        </div>

        <!-- Fehler anzeigen -->
        {% if import_data.errors %}
        <div class="mb-6 bg-red-50 border border-red-200 rounded-md p-4">
            <div class="flex">
                <svg class="h-5 w-5 text-red-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <div class="flex-1">
                    <h3 class="text-sm font-medium text-red-800">Fehler gefunden</h3>
                    <div class="mt-2 text-sm text-red-700">
                        <ul class="list-disc list-inside space-y-1">
                            {% for error in import_data.errors %}
                            <li>Zeile {{ error.row }}: {{ error.message }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Familien-Übersicht -->
        {% if import_data.families %}
        <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-900 mb-3">Neue Familien ({{ import_data.families|length }})</h3>
            <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
                <div class="space-y-2">
                    {% for family_num, members in import_data.families.items() %}
                    <div class="flex items-center">
                        <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-green-100 text-green-800 mr-3">
                            Familie {{ family_num }}
                        </span>
                        <span class="text-sm text-gray-700">
                            {{ members|length }} Mitglied{% if members|length != 1 %}er{% endif %}:
                            {% for member in members %}{{ member.first_name }} {{ member.last_name }}{% if not loop.last %}, {% endif %}{% endfor %}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Teilnehmer-Tabelle -->
        <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-900 mb-3">Teilnehmer-Details</h3>
            <div class="overflow-x-auto border border-gray-200 rounded-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vorname</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nachname</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Geburtsdatum</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Geschlecht</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">E-Mail</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Telefon</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Familie</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for participant in import_data.participants %}
                        <tr class="{% if participant.has_error %}bg-red-50{% else %}hover:bg-gray-50{% endif %}">
                            <td class="px-4 py-3 text-sm">{{ participant.first_name }}</td>
                            <td class="px-4 py-3 text-sm">{{ participant.last_name }}</td>
                            <td class="px-4 py-3 text-sm">{{ participant.birth_date }}</td>
                            <td class="px-4 py-3 text-sm">{{ participant.gender or '-' }}</td>
                            <td class="px-4 py-3 text-sm">{{ participant.email or '-' }}</td>
                            <td class="px-4 py-3 text-sm">{{ participant.phone or '-' }}</td>
                            <td class="px-4 py-3 text-sm">
                                {% if participant.family_number %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                    Familie {{ participant.family_number }}
                                </span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Aktionen -->
        <form method="post" action="/participants/import/confirm" class="flex gap-3">
            <input type="hidden" name="import_data" value="{{ import_data_json }}">

            {% if import_data.errors %}
            <div class="flex-1 bg-yellow-50 border border-yellow-200 rounded-md p-3">
                <p class="text-sm text-yellow-800">
                    ⚠️ Es wurden Fehler gefunden. Sie können trotzdem fortfahren, aber fehlerhafte Zeilen werden übersprungen.
                </p>
            </div>
            {% endif %}

            <button type="submit"
                    class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition font-medium">
                Import bestätigen ({{ import_data.participants|length - import_data.errors|length }} Teilnehmer)
            </button>
            <a href="/participants/import"
               class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">
                Zurück
            </a>
        </form>
    </div>
</div>
{% endblock %}
